version: '3.8'

services:
  # SlotScribe Viewer (身体/控制面板)
  viewer:
    image: ghcr.io/kledx/slotscribe:latest
    pull_policy: always
    ports:
      - "3101:${PORT:-3000}"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_DEFAULT_CLUSTER=${NEXT_PUBLIC_DEFAULT_CLUSTER:-mainnet-beta}
      - PORT=${PORT:-3000}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - MAINNET_RPC_URL=${MAINNET_RPC_URL}
      - DEVNET_RPC_URL=${DEVNET_RPC_URL}
      - API_KEY=${API_KEY}
      - BASE_URL=${BASE_URL}
      - COLOSSEUM_API_KEY=${COLOSSEUM_API_KEY}
      - AGENT_CONFIG_PATH=/app/data/.colosseum-agent.json
      - AGENT_MODE=${AGENT_MODE:-active}
      - OPENAI_MODEL_FOR_POSTS=${OPENAI_MODEL_FOR_POSTS:-gemini-3-pro-preview}
      - OPENAI_MODEL_FOR_REPLIES=${OPENAI_MODEL_FOR_REPLIES:-gemini-3-flash-preview}
    volumes:
      - agent_data:/app/data
    restart: always

  # SlotScribe Agent (大脑/自动执行)
  agent:
    image: ghcr.io/kledx/slotscribe:latest
    pull_policy: always
    command: [ "npx", "tsx", "scripts/colosseum-agent.ts", "agent:run" ]
    environment:
      - NODE_ENV=production
      - API_KEY=${API_KEY}
      - BASE_URL=${BASE_URL}
      - COLOSSEUM_API_KEY=${COLOSSEUM_API_KEY}
      - AGENT_CONFIG_PATH=/app/data/.colosseum-agent.json
      - AGENT_MODE=${AGENT_MODE:-active}
      - OPENAI_MODEL_FOR_POSTS=${OPENAI_MODEL_FOR_POSTS:-gemini-3-pro-preview}
      - OPENAI_MODEL_FOR_REPLIES=${OPENAI_MODEL_FOR_REPLIES:-gemini-3-flash-preview}
    volumes:
      - agent_data:/app/data
    restart: always
    depends_on:
      - viewer

volumes:
  agent_data:
